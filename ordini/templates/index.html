{% extends "page_skeleton.html" %}

{% block content %}
<h3>Tabella ordini per {{request.session.utente}}</h3>

	<div class="table-responsive">
		<table class="table table-hover" id="order_list_table" name="order_list_table">
			<caption>Lista ordini per {{request.session.utente}}</caption>
			<thead class="table-light">
				<th scope="col"><span class="ordina" sort="ord_num"><i class="fas fa-sort"></i> Order ID</span></th>
				<th scope="col"><span class="ordina" sort="ord_date"><i class="fas fa-sort"></i> Date</span></th>
				<th scope="col"><span class="ordina" sort="ord_amount"><i class="fas fa-sort"></i> Amount</span></th>
				<th scope="col"><span class="ordina" sort="advance_amount"><i class="fas fa-sort"></i> Advance amount</span></th>
			{% if request.session.gruppo == "agents" or request.session.gruppo == "managers" %}
				<th scope="col"><span class="ordina" sort="cust_code"><i class="fas fa-sort"></i> Customer</span></th>
			{% elif request.session.gruppo == "customers" or request.session.gruppo == "managers"  %}
				<th scope="col"><span class="ordina" sort="cust_code"><i class="fas fa-sort"></i> Agent</span></th>
			{% endif %}
				<th scope="col">Description</th>
				<th scope="col">&nbsp;</th>
			</thead>
			<tbody id="orderTable">
		{% for i in order_list %} 
				<tr id="row_{{ i.ord_num }}">
					<td>{{ i.ord_num }}</td>
          <td>{{ i.ord_date|date:'d/m/Y' }}</td>
          <td>{{ i.ord_amount }}</td>
          <td>{{ i.advance_amount }}</td>
			{% if request.session.gruppo == "agents" or request.session.gruppo == "managers" %}
          <td id="{{ i.cust_code }}"> {{ i.cust_code.cust_name }}</td>
      {% elif request.session.gruppo == "customers" or request.session.gruppo == "managers"  %}
          <td id="{{ i.agent_code }}"> {{ i.agent_code.agent_name }}</td>
      {% endif %}
					<td>{{ i.ord_description }}</td>
			{% if request.session.gruppo == "agents" or request.session.gruppo == "managers" %}
          <td class="nowrap">
						<a href="/ordini/modifica/{{ i.ord_num  }}/"><i class='fas fa-edit'></i></a>
							&nbsp;&nbsp;&nbsp;
						<a class="delete_order" id="{{ i.ord_num }}"><i class='fas fa-trash-alt'></i></a>
					</td>
      {% elif request.session.gruppo == "customers" %}
					<td>&nbsp;</td>
      {% endif %}
        </tr>
					
		{% endfor %}

			</tbody>
		</table>
	</div>

	<form>
		{% csrf_token  %}
	</form>

	<script type="text/javascript">
	/* Avendo messo nei settings di Django CSRF_USE_SESSIONS = True
   * e CSRF_COOKIE_HTTPONLY = True, richiamo il token csrf semplicemente
   * dal campo (nascosto) html, che sarebbe poi rappresentato dalla
   * istruzione {% csrf_token %} */
	 const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

	/*
	 * Cancellazione ordine
	 */
	$(".delete_order").click(function(e) {
		e.preventDefault();

		// recupero l'id dell'ordine da cancellare
		ord = $(this).attr('id');

		// Richiesta AJAX DELETE. Non servono dati JSON o altro,
		// ma il token csrf va passato anche in questo caso...
		$.ajax({
			url: "/api/orders/delete/" + ord + "/",
			type: 'DELETE',
			headers: {
        'X-CSRFToken': csrftoken
      }, 
			success: function(message) {
				$('#row_' + ord).fadeOut(300, function(){
					$(this).remove();
				})
				
				//$('#row_' + ord).remove();
			},
			error: function(message) {
				//alert(message.responseText)
			}

		}) 

	});

	/*
	 * Ordinamento colonne
	 */
	$(".ordina").click(function(e) {
		e.preventDefault();
		sort = $(this).attr('sort');

		$.ajax({
        url: '/api/orders/?sort_by=' + sort,
        type: 'GET',
        dataType: 'json',
        success: function(response) {
					// Svuoto il il tbody prima di fare l'append
					// delle righe ordinate!
					$('#orderTable').empty();

					// Recupero i dati dall'oggetto response 
					// restituito dalla chiamata all'API
					// e appendo le righe ordinate
          var len = response.length;

					for(var i=0; i<len; i++){
                var ord_num = response[i].ord_num;
                var ord_date = response[i].ord_date;
                var ord_amount = response[i].ord_amount;
                var advance_amount = response[i].advance_amount;
                var cust_code = response[i].cust_code;
                var agent_code = response[i].agent_code;
                var cust_name = response[i].cust_name;
                var agent_name = response[i].agent_name;
                var ord_description = response[i].ord_description;

                var tr_str = '<tr id="row_'+ ord_num + '">' +
                    '<td>' + ord_num + '</td>' +
                    '<td>' + ord_date + '</td>' +
                    '<td>' + ord_amount + '</td>' +
                    '<td>' + advance_amount + '</td>' +
                {% if request.session.gruppo == "agents" or request.session.gruppo == "managers" %}
                    '<td id="' + cust_code + '">' + cust_name + '</td>' +
                {% elif request.session.gruppo == "customers" or request.session.gruppo == "managers"  %}
                    '<td id="' + agent_code + '">' + agent_name + '</td>' +
                {% endif %}
                    '<td>' + ord_description + '</td>' +
								{% if request.session.gruppo == "agents" or request.session.gruppo == "managers" %}
                    '<td class="nowrap"><a href="/ordini/modifica/' + ord_num + '"><i class="fas fa-edit"></i></a>' +
										'&nbsp;&nbsp;&nbsp;' + 
										'<a class="delete_order" id="' + ord_num + '"><i class="fas fa-trash-alt"></i></a></td>' +
                    '</tr>';
								{% elif request.session.gruppo == "customers" %}
										'<td>&nbsp;</td>';
								{% endif %}

                $("#orderTable").append(tr_str);
          }
				}
			});
	});

	</script>

{% endblock %}
